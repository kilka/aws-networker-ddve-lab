# AWS NetWorker Lab - Ansible Automation

Complete automation for AWS NetWorker Lab deployment using REST APIs and best practices.

## Python Requirements

### Control Node (where Ansible runs)
- Python 3.9 or higher (required for Ansible 2.14+)
- Install Ansible: `pip install ansible>=2.14.0`

### Managed Nodes (RHEL 8 EC2 instances)
- Uses built-in platform-python (Python 3.6) at `/usr/libexec/platform-python`
- **Important**: Do NOT upgrade Python on RHEL 8 managed nodes
- Platform-python includes all necessary system modules (DNF, yum, etc.)

## Quick Start

```bash
# Full deployment (when infrastructure is ready)
ansible-playbook playbooks/site.yml

# Test individual components
ansible-playbook playbooks/site.yml --tags ddve -i inventory/test.yml

# Run validation only
ansible-playbook playbooks/site.yml --tags validate
```

## Modular Execution

The playbook is designed to be run as a **single script** with **modular execution** using tags:

### Infrastructure Components
```bash
# DDVE only (Data Domain Virtual Edition)
ansible-playbook playbooks/site.yml --tags ddve

# NetWorker server only  
ansible-playbook playbooks/site.yml --tags networker

# Client agents only
ansible-playbook playbooks/site.yml --tags agents
```

### Functional Groups
```bash
# All infrastructure (DDVE + NetWorker + common)
ansible-playbook playbooks/site.yml --tags infrastructure

# All configuration (agents + backup policies)
ansible-playbook playbooks/site.yml --tags configuration

# Validation and testing
ansible-playbook playbooks/site.yml --tags validate
```

### Development/Testing
```bash
# Test with specific inventory
ansible-playbook playbooks/site.yml -i inventory/test.yml --tags ddve

# Run common setup only (usually skipped)
ansible-playbook playbooks/site.yml --tags common

# Check connectivity only
ansible-playbook playbooks/site.yml --tags never --skip-tags never
```

## Inventory Structure

### Production (from Terraform)
Uses `inventory/dynamic_inventory.json` generated by Terraform with all components.

### Testing
Uses `inventory/test.yml` for individual component testing:
- Contains only the components you want to test
- Override variables as needed
- Perfect for development and troubleshooting

## DDVE Configuration

The DDVE role now uses **REST API automation** with:

### Smart Timeouts
- **Quick operations** (30s): Authentication, status checks, disk listing
- **Medium operations** (60s): DD Boost, user creation, storage units  
- **Long operations** (300s): S3 configuration, filesystem operations

### Intelligent Configuration
- **Checks existing state** before making changes
- **Skips completed steps** automatically
- **Idempotent operations** - safe to run multiple times
- **Comprehensive error handling**

### Key Features
- ✅ **S3 Object Store** - Automatic configuration with bucket validation
- ✅ **IAM Integration** - Uses EC2 instance roles for S3 access
- ✅ **DD Boost Setup** - Creates users, storage units, and permissions
- ✅ **Filesystem Management** - Creates and enables DDVE filesystem
- ✅ **REST API Native** - No CLI dependencies or SSH requirements

## Examples

### Test DDVE Configuration
```bash
# Test against live DDVE instance
ansible-playbook playbooks/site.yml -i inventory/test.yml --tags ddve -v

# Check what would be configured
ansible-playbook playbooks/site.yml --tags ddve --check --diff
```

### Development Workflow
```bash
# 1. Test individual component
ansible-playbook playbooks/site.yml -i inventory/test.yml --tags ddve

# 2. Verify with validation
ansible-playbook playbooks/site.yml -i inventory/test.yml --tags validate

# 3. Deploy to production
ansible-playbook playbooks/site.yml --tags ddve
```

### Troubleshooting
```bash
# Run with maximum verbosity
ansible-playbook playbooks/site.yml --tags ddve -vvv

# Check inventory and variables
ansible-inventory -i inventory/test.yml --list

# Test connectivity
ansible all -i inventory/test.yml -m ping
```

## Requirements

- **Ansible 2.9+** with `uri` module support
- **Python 3.6+** with `json` library
- **Network access** to DDVE on ports 443 and 3009
- **IAM permissions** for S3 bucket access (automatically configured by Terraform)

## Variables

Key variables are defined in:
- `group_vars/all.yml` - Global settings
- `inventory/*/` - Environment-specific overrides
- `roles/*/defaults/main.yml` - Role defaults

### Important DDVE Variables
```yaml
# Authentication
ddve_username: "sysadmin"
ddve_password: "your-password"
ddve_passphrase: "DataDomain123!"

# S3 Configuration  
s3_bucket: "your-bucket-name"

# DD Boost
ddboost_user: "networker"
ddboost_password: "NetWorker123!"
storage_unit_name: "NetWorker_SU"
```

## Architecture

```
├── playbooks/
│   └── site.yml              # Main modular playbook
├── inventory/
│   ├── dynamic_inventory.json # Generated by Terraform
│   └── test.yml              # For component testing
├── roles/
│   ├── configure_ddve/       # DDVE REST API automation
│   ├── configure_nve/        # NetWorker server setup
│   ├── install_agent/        # Client agent installation
│   └── configure_backup/     # Backup policies & validation
└── group_vars/
    └── all.yml               # Global variables
```

This structure provides:
- **Single script** for complete deployment
- **Modular execution** for testing individual components  
- **Consistent inventory** across environments
- **Professional automation** with proper error handling
- **Easy troubleshooting** with comprehensive logging